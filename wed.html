<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Phân loại tình trạng giao thông</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    /* Light theme */
    --bg: #fafafa;
    --card: #ffffff;
    --muted: #6b7280;
    --text: #111827;
    --primary: #3b82f6;
    --primary-600: #2563eb;
    --primary-50: #eff6ff;
    --accent: #f3f4f6;
    --ok: #10b981;
    --warn: #f59e0b;
    --bad: #ef4444;
    --border: #e5e7eb;
    --row-hover: rgba(59, 130, 246, 0.05);
    --input-bg: #ffffff;
    --shadow-1: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-2: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-3: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-4: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    
    /* Dark theme */
    --bg-dark: #111827;
    --card-dark: #1f2937;
    --muted-dark: #9ca3af;
    --text-dark: #f9fafb;
    --border-dark: #374151;
    --input-bg-dark: #374151;
  }
  
  [data-theme="dark"] {
    --bg: var(--bg-dark);
    --card: var(--card-dark);
    --muted: var(--muted-dark);
    --text: var(--text-dark);
    --border: var(--border-dark);
    --input-bg: var(--input-bg-dark);
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg);
    color: var(--text);
    transition: background-color 0.3s ease, color 0.3s ease;
    line-height: 1.6;
  }
  .container { 
    max-width: 1400px; 
    margin: 0 auto; 
    padding: 24px 20px; 
    min-height: 100vh;
  }
  
  header { 
    display: flex; 
    gap: 20px; 
    align-items: center; 
    justify-content: space-between; 
    margin-bottom: 32px; 
    padding: 24px 0; 
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .title { 
    display: flex; 
    align-items: center; 
    gap: 16px; 
    flex: 1;
  }
  
  .logo { 
    width: 64px; 
    height: 64px; 
    border-radius: 20px; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 
      0 20px 40px rgba(102, 126, 234, 0.4),
      0 8px 16px rgba(118, 75, 162, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    display: grid; 
    place-items: center; 
    overflow: hidden; 
    background-size: cover; 
    background-position: center; 
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    border: 2px solid rgba(255, 255, 255, 0.1);
  }
  
  .logo::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transform: rotate(45deg);
    transition: all 0.6s ease;
  }
  
  .logo:hover::before {
    transform: rotate(45deg) translate(50%, 50%);
  }
  
  .logo:hover { 
    transform: translateY(-4px) scale(1.08) rotate(2deg); 
    box-shadow: 
      0 30px 60px rgba(102, 126, 234, 0.5),
      0 15px 30px rgba(118, 75, 162, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }
  
  .logo svg { 
    width: 32px; 
    height: 32px; 
    color: white;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    transition: all 0.3s ease;
  }
  
  .logo:hover svg {
    transform: scale(1.1);
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
  }
  
  h1 { 
    font-size: 28px; 
    font-weight: 700;
    margin: 0; 
    letter-spacing: -0.025em;
    background: linear-gradient(135deg, var(--text), var(--muted));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .muted { 
    color: var(--muted); 
    font-size: 15px;
    margin-top: 4px;
  }



  .toolbar { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    flex-wrap: wrap;
    justify-content: flex-end;
  }
  
  .k-ctrl { 
    display: inline-flex; 
    align-items: center; 
    gap: 8px; 
    padding: 10px 16px; 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    background: var(--card); 
    color: var(--muted); 
    font-size: 14px; 
    font-weight: 500;
    box-shadow: var(--shadow-1);
    transition: all 0.2s ease;
  }
  
  .k-ctrl:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-2);
  }
  
  .toolbar button { 
    background: linear-gradient(135deg, #667eea, #764ba2); 
    color: white; 
    border: none; 
    border-radius: 12px; 
    padding: 12px 20px; 
    font-weight: 600; 
    font-size: 14px;
    cursor: pointer; 
    box-shadow: 
      0 4px 12px rgba(102, 126, 234, 0.3),
      0 2px 4px rgba(118, 75, 162, 0.2);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .toolbar button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  .toolbar button:hover::before {
    left: 100%;
  }
  
  .toolbar button:hover { 
    transform: translateY(-3px) scale(1.05); 
    box-shadow: 
      0 8px 25px rgba(102, 126, 234, 0.4),
      0 4px 8px rgba(118, 75, 162, 0.3);
  }
  
  .toolbar button:active { 
    transform: translateY(0); 
  }
  
  .toolbar button.secondary { 
    background: var(--card); 
    color: var(--text); 
    box-shadow: var(--shadow-1); 
    border: 1px solid var(--border);
  }
  
  .toolbar button.secondary:hover {
    background: var(--accent);
    border-color: var(--primary);
  }
  
  .toolbar button.primary {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    font-weight: 700;
    padding: 12px 24px;
  }
  
  .toolbar button.primary:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-3px) scale(1.05);
  }
  
  /* Navigation */
  .main-nav {
    margin: 0 0 32px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .nav-container {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 0 4px;
  }
  
  .nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    color: var(--muted);
    text-decoration: none;
    border-radius: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
    border: 1px solid transparent;
  }
  
  .nav-item:hover {
    color: var(--primary);
    background: var(--primary-50);
    border-color: var(--primary);
  }
  
  .nav-item.active {
    color: var(--primary);
    background: var(--primary-50);
    border-color: var(--primary);
    font-weight: 600;
  }
  
  .nav-icon {
    font-size: 18px;
  }
  
  .hero { 
    margin: 24px 0 32px; 
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(240, 147, 251, 0.05), rgba(255,255,255,0.9)); 
    border: 1px solid rgba(102, 126, 234, 0.2); 
    border-radius: 24px; 
    padding: 40px; 
    display: grid; 
    grid-template-columns: 1fr 300px; 
    gap: 32px; 
    align-items: center; 
    box-shadow: 
      0 20px 40px rgba(102, 126, 234, 0.1),
      0 8px 16px rgba(118, 75, 162, 0.1);
    position: relative;
    overflow: hidden;
  }
  
  .hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.1), transparent 70%);
    border-radius: 50%;
    opacity: 0.8;
    animation: pulse 4s ease-in-out infinite;
  }
  
  .hero::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -10%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(240, 147, 251, 0.1), transparent 70%);
    border-radius: 50%;
    opacity: 0.6;
    animation: pulse 4s ease-in-out infinite 2s;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.6; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  
  .hero h3 { 
    margin: 0 0 12px; 
    font-size: 24px; 
    font-weight: 700;
    color: var(--text);
  }
  
  .hero p { 
    margin: 0 0 24px 0; 
    color: var(--muted); 
    font-size: 16px;
    line-height: 1.6;
  }
  
  .hero-stats {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
  }
  
  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.1);
    backdrop-filter: blur(10px);
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .hero-art { 
    height: 180px; 
    border-radius: 24px; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    position: relative; 
    box-shadow: 
      0 25px 50px rgba(102, 126, 234, 0.4),
      0 10px 20px rgba(118, 75, 162, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255, 255, 255, 0.1);
  }
  
  .hero-art::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
      radial-gradient(circle at 70% 80%, rgba(240, 147, 251, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    border-radius: 24px;
  }
  
  .hero-art::after { 
    content: '🚗'; 
    font-size: 64px;
    position: relative;
    z-index: 2;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    animation: float 3s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-10px) rotate(2deg); }
  }
  
  .hero-art:hover::after {
    animation: bounce 0.6s ease-in-out;
  }
  
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-20px); }
    60% { transform: translateY(-10px); }
  }

  .kpi-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 20px; 
    margin-bottom: 32px; 
  }
  
  .kpi { 
    background: var(--card); 
    border: 1px solid var(--border); 
    border-radius: 20px; 
    padding: 28px; 
    box-shadow: var(--shadow-1);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }
  
  .kpi::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
  }
  
  .kpi::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.05), transparent);
    transform: rotate(45deg);
    transition: all 0.6s ease;
  }
  
  .kpi:hover::after {
    transform: rotate(45deg) translate(50%, 50%);
  }
  
  .kpi:hover { 
    transform: translateY(-6px) scale(1.02); 
    box-shadow: 
      0 25px 50px rgba(102, 126, 234, 0.15),
      0 10px 20px rgba(118, 75, 162, 0.1);
  }
  
  .kpi .label { 
    font-size: 14px; 
    color: var(--muted); 
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .kpi .value { 
    font-size: 36px; 
    font-weight: 700; 
    margin-top: 8px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    transition: all 0.3s ease;
  }
  
  .kpi:hover .value {
    background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .grid { 
    display: grid; 
    grid-template-columns: 2fr 1fr; 
    gap: 24px; 
  }
  
  @media (max-width: 1200px) { 
    .grid { 
      grid-template-columns: 1fr; 
      gap: 20px;
    } 
  }
  
  @media (max-width: 768px) {
    .container {
      padding: 16px;
    }
    
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .toolbar {
      justify-content: flex-start;
      width: 100%;
    }
    
    .hero {
      grid-template-columns: 1fr;
      padding: 24px;
    }
    
    .kpi-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .card { 
    background: var(--card); 
    border: 1px solid var(--border); 
    border-radius: 20px; 
    box-shadow: var(--shadow-1);
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .card:hover {
    box-shadow: var(--shadow-2);
  }
  .card-header { 
    display: flex; 
    align-items: stretch; 
    justify-content: space-between; 
    padding: 0; 
    cursor: pointer; 
    user-select: none; 
    position: relative;
    transition: background-color 0.2s ease;
  }
  
  .card-header:hover {
    background: var(--accent);
  }
  
  .card-title { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    padding: 20px 24px; 
    width: 100%; 
  }
  
  .card-title .dot { 
    width: 12px; 
    height: 12px; 
    border-radius: 50%; 
    background: linear-gradient(135deg, #667eea, #764ba2);
    box-shadow: 
      0 0 0 3px rgba(102, 126, 234, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
    position: relative;
  }
  
  .card-title .dot::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
  }
  
  .card-title h2 { 
    font-size: 18px; 
    font-weight: 600;
    margin: 0; 
    letter-spacing: -0.025em;
    color: var(--text);
  }
  .chev-btn { 
    padding: 0 20px; 
    border-left: 1px solid var(--border); 
    background: transparent; 
    display: grid; 
    place-items: center;
    transition: background-color 0.2s ease;
  }
  
  .chev-btn:hover {
    background: rgba(59, 130, 246, 0.05);
  }
  
  .chev-btn svg { 
    width: 18px; 
    height: 18px; 
    stroke: var(--muted); 
    transition: all 0.2s ease;
  }
  .card.open .chev-btn svg { transform: rotate(90deg); }
  .chev { transition: transform 160ms ease; color: var(--muted); }
  .card-body { 
    padding: 0 24px 24px; 
    display: none; 
    animation: fadeSlide 0.3s ease; 
  }
  .card.open .card-body { display: block; }
  .card.open .chev { transform: rotate(90deg); }
  @keyframes fadeSlide { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

  table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 14px;
    background: var(--card);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-1);
  }
  
  th, td { 
    text-align: left; 
    padding: 12px 16px; 
    border-bottom: 1px solid var(--border); 
  }
  
  thead th { 
    color: var(--muted); 
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--accent);
  }
  
  tbody tr { 
    transition: all 0.2s ease; 
  }
  
  tbody tr:hover { 
    background: var(--row-hover);
    transform: scale(1.01);
  }
  
  tbody tr:last-child td {
    border-bottom: none;
  }
  .pill { 
    display: inline-flex; 
    align-items: center; 
    gap: 6px; 
    padding: 8px 12px; 
    border-radius: 12px; 
    font-weight: 600; 
    font-size: 12px; 
    letter-spacing: 0.2px;
    transition: all 0.2s ease;
  }
  
  .pill.ok { 
    background: rgba(16, 185, 129, 0.1); 
    color: var(--ok); 
    border: 1px solid rgba(16, 185, 129, 0.2);
  }
  
  .pill.warn { 
    background: rgba(245, 158, 11, 0.1); 
    color: var(--warn); 
    border: 1px solid rgba(245, 158, 11, 0.2);
  }
  
  .pill.bad { 
    background: rgba(239, 68, 68, 0.1); 
    color: var(--bad); 
    border: 1px solid rgba(239, 68, 68, 0.2);
  }
  
  .pill:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-2);
  }
  .controls { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 16px; 
  }
  
  .control { 
    display: flex; 
    flex-direction: column; 
    gap: 8px; 
  }
  
  label { 
    font-size: 14px; 
    color: var(--muted); 
    font-weight: 500;
  }
  
  input[type="number"], select { 
    background: var(--input-bg); 
    color: var(--text); 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 12px 16px; 
    outline: none; 
    font-size: 14px;
    transition: all 0.2s ease;
  }
  input[type="number"]:focus, select:focus { 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    transform: translateY(-1px);
  }
  .actions { 
    display: flex; 
    align-items: center; 
    gap: 16px; 
    flex-wrap: wrap;
    margin-top: 16px;
  }
  
  button { 
    background: linear-gradient(135deg, var(--primary), var(--primary-600)); 
    color: white; 
    border: none; 
    border-radius: 12px; 
    padding: 12px 20px; 
    font-weight: 600; 
    font-size: 14px;
    cursor: pointer; 
    box-shadow: var(--shadow-1); 
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  
  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  button:hover::before {
    left: 100%;
  }
  
  button:hover { 
    transform: translateY(-2px); 
    box-shadow: var(--shadow-3);
  }
  
  button:active { 
    transform: translateY(0); 
  }
  
  button.secondary { 
    background: var(--card); 
    color: var(--text); 
    box-shadow: var(--shadow-1); 
    border: 1px solid var(--border);
  }
  
  button.secondary:hover {
    background: var(--accent);
    border-color: var(--primary);
  }

  .k-badge { margin-left: auto; font-size: 12px; color: var(--muted); }
  .footer-note { 
    color: var(--muted); 
    font-size: 13px; 
    margin-top: 16px;
    padding: 12px 16px;
    background: var(--accent);
    border-radius: 8px;
    border-left: 3px solid var(--primary);
  }

  .toast { 
    position: fixed; 
    right: 24px; 
    bottom: 24px; 
    display: none; 
    background: var(--card); 
    color: var(--text); 
    padding: 16px 20px; 
    border-radius: 16px; 
    box-shadow: var(--shadow-4);
    border: 1px solid var(--border);
    z-index: 1000;
    font-weight: 500;
    min-width: 200px;
  }
  
  .toast.show { 
    display: block; 
    animation: slideIn 0.3s ease-out; 
  }
  
  @keyframes slideIn { 
    from { 
      transform: translateX(100%) translateY(0); 
      opacity: 0; 
    } 
    to { 
      transform: translateX(0) translateY(0); 
      opacity: 1; 
    } 
  }
  
  @keyframes fadeIn { 
    from { 
      transform: translateY(8px); 
      opacity: 0; 
    } 
    to { 
      transform: translateY(0); 
      opacity: 1; 
    } 
  }
  
  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
  }
  
  .modal.show {
    display: block;
    animation: fadeIn 0.3s ease;
  }
  
  .modal-content {
    background-color: var(--card);
    margin: 5% auto;
    padding: 0;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    box-shadow: var(--shadow-4);
    border: 1px solid var(--border);
    animation: slideDown 0.3s ease;
  }
  
  @keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 24px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  
  .modal-header h3 {
    margin: 0;
    color: var(--text);
    font-size: 20px;
  }
  
  .close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: var(--muted);
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  
  .close-btn:hover {
    background: var(--accent);
    color: var(--text);
  }
  
  /* Chatbot Styles */
  .chat-container {
    padding: 0 24px 24px;
  }
  
  .chat-messages {
    height: 300px;
    overflow-y: auto;
    margin-bottom: 16px;
    padding: 16px;
    background: var(--accent);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .message {
    margin-bottom: 16px;
  }
  
  .message.bot .message-content {
    background: var(--primary);
    color: white;
    padding: 12px 16px;
    border-radius: 18px 18px 18px 4px;
    max-width: 80%;
    display: inline-block;
  }
  
  .message.user .message-content {
    background: var(--card);
    color: var(--text);
    padding: 12px 16px;
    border-radius: 18px 18px 4px 18px;
    max-width: 80%;
    display: inline-block;
    margin-left: auto;
    border: 1px solid var(--border);
  }
  
  .chat-input {
    display: flex;
    gap: 12px;
  }
  
  .chat-input input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    outline: none;
    font-size: 14px;
  }
  
  .chat-input button {
    padding: 12px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
  }
  
  /* Admin Panel Styles */
  .admin-content {
    max-width: 800px;
  }
  
  .admin-tabs {
    display: flex;
    gap: 8px;
    padding: 0 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  
  .tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    border-radius: 12px 12px 0 0;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .tab-btn.active {
    color: var(--primary);
    background: var(--primary-50);
    border-bottom: 2px solid var(--primary);
  }
  
  .tab-content {
    padding: 0 24px 24px;
  }
  
  .tab-pane {
    display: none;
  }
  
  .tab-pane.active {
    display: block;
  }
  
  .admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  
  .admin-stat {
    background: var(--accent);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid var(--border);
  }
  
  .admin-stat-number {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
  }
  
  .admin-stat-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  
  .status-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--accent);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #10b981;
  }
  
  .status-item.offline .status-dot {
    background: #ef4444;
  }
  
  .log-list {
    margin-top: 16px;
  }
  
  .log-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--accent);
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid var(--border);
  }
  
  .log-time {
    color: var(--muted);
    font-size: 12px;
    font-weight: 500;
  }
  
  .log-action {
    color: var(--text);
    font-weight: 500;
  }
  
  .log-user {
    color: var(--primary);
    font-size: 12px;
  }
  
  /* Login Styles */
  .login-content {
    max-width: 500px;
  }
  
  .auth-tabs {
    display: flex;
    gap: 0;
    padding: 0 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  
  .auth-tab {
    flex: 1;
    padding: 16px 20px;
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
  }
  
  .auth-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }
  
  .auth-form {
    display: none;
    padding: 0 24px 24px;
  }
  
  .auth-form.active {
    display: block;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--text);
    font-weight: 500;
  }
  
  .form-group input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    outline: none;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  .form-group input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .auth-btn {
    width: 100%;
    padding: 14px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .auth-btn:hover {
    background: var(--primary-600);
    transform: translateY(-2px);
  }
  
  .auth-links {
    text-align: center;
    margin-top: 16px;
  }
  
  .forgot-password {
    color: var(--primary);
    text-decoration: none;
    font-size: 14px;
  }
  
  .forgot-password:hover {
    text-decoration: underline;
  }
  
  /* Content Sections */
  .content-section {
    display: none;
  }
  
  .content-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }
  
  /* Analytics Section */
  .analytics-header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  .analytics-header h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 8px 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .analytics-header p {
    color: var(--muted);
    font-size: 16px;
    margin: 0;
  }
  
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }
  
  .analytics-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    box-shadow: var(--shadow-1);
    transition: all 0.3s ease;
  }
  
  .analytics-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-3);
  }
  
  .analytics-card h3 {
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  
  .chart-container {
    background: var(--accent);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid var(--border);
  }
  
  .analytics-insights {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .insight-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--accent);
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  .insight-label {
    font-weight: 500;
    color: var(--muted);
  }
  
  .insight-value {
    font-weight: 600;
    color: var(--primary);
  }
  
  .weather-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  
  .weather-stat {
    text-align: center;
    padding: 16px;
    background: var(--accent);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .weather-icon {
    font-size: 24px;
    display: block;
    margin-bottom: 8px;
  }
  
  .weather-label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
  }
  
  .weather-value {
    display: block;
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
  }
  
  .weather-impact {
    padding: 12px 16px;
    background: var(--primary-50);
    border-radius: 8px;
    border-left: 3px solid var(--primary);
  }
  
  .weather-impact p {
    margin: 0;
    font-size: 14px;
    color: var(--text);
  }
  
  .model-metrics {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--accent);
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  .metric-name {
    font-weight: 500;
    color: var(--text);
  }
  
  .metric-value {
    font-weight: 700;
    color: var(--primary);
  }
  
  .train-model-btn {
    width: 100%;
    padding: 12px 20px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .train-model-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-2);
  }
  
  /* ML Models Section */
  .models-header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  .models-header h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 8px 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .models-header p {
    color: var(--muted);
    font-size: 16px;
    margin: 0;
  }
  
  .models-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }
  
  .model-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    box-shadow: var(--shadow-1);
    transition: all 0.3s ease;
  }
  
  .model-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-3);
  }
  
  .model-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .model-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  
  .model-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .model-status.active {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }
  
  .model-status.training {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.2);
  }
  
  .model-status.inactive {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
    border: 1px solid rgba(107, 114, 128, 0.2);
  }
  
  .model-info {
    margin-bottom: 16px;
  }
  
  .model-info p {
    margin: 0 0 12px 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .model-params {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .param {
    padding: 4px 8px;
    background: var(--accent);
    border-radius: 6px;
    font-size: 12px;
    color: var(--muted);
    border: 1px solid var(--border);
  }
  
  .model-performance {
    margin-bottom: 20px;
  }
  
  .perf-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .perf-item:last-child {
    border-bottom: none;
  }
  
  .perf-label {
    font-weight: 500;
    color: var(--muted);
  }
  
  .perf-value {
    font-weight: 700;
    color: var(--primary);
  }
  
  .model-actions {
    display: flex;
    gap: 12px;
  }
  
  .model-btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .model-btn.primary {
    background: var(--primary);
    color: white;
  }
  
  .model-btn.secondary {
    background: var(--card);
    color: var(--text);
    border: 1px solid var(--border);
  }
  
  .model-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-2);
  }
  
  /* Reports Section */
  .reports-header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  .reports-header h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 8px 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .reports-header p {
    color: var(--muted);
    font-size: 16px;
    margin: 0;
  }
  
  .reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }
  
  .report-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    text-align: center;
    box-shadow: var(--shadow-1);
    transition: all 0.3s ease;
  }
  
  .report-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-3);
  }
  
  .report-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }
  
  .report-card h3 {
    margin: 0 0 12px 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  
  .report-card p {
    margin: 0 0 20px 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .report-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    font-size: 12px;
  }
  
  .report-date {
    color: var(--muted);
  }
  
  .report-status {
    padding: 2px 8px;
    border-radius: 8px;
    font-weight: 600;
  }
  
  .report-status:contains("Ready") {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }
  
  .report-status:contains("Processing") {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
  }
  
  .report-btn {
    width: 100%;
    padding: 12px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .report-btn:hover:not(:disabled) {
    background: var(--primary-600);
    transform: translateY(-2px);
    box-shadow: var(--shadow-2);
  }
  
  .report-btn:disabled {
    background: var(--muted);
    cursor: not-allowed;
  }
  
  /* Settings Section */
  .settings-header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  .settings-header h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 8px 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .settings-header p {
    color: var(--muted);
    font-size: 16px;
    margin: 0;
  }
  
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }
  
  .settings-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    box-shadow: var(--shadow-1);
  }
  
  .settings-card h3 {
    margin: 0 0 20px 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  
  .setting-item {
    margin-bottom: 20px;
  }
  
  .setting-item label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text);
  }
  
  .setting-select,
  .setting-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  .setting-select:focus,
  .setting-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
  }
  
  .toggle-switch {
    position: relative;
    width: 50px;
    height: 24px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-switch label {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--muted);
    transition: 0.4s;
    border-radius: 24px;
  }
  
  .toggle-switch label:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }
  
  .toggle-switch input:checked + label {
    background-color: var(--primary);
  }
  
  .toggle-switch input:checked + label:before {
    transform: translateX(26px);
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo" id="logo-box">
          <svg id="logo-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M4 17c0-3.866 3.582-7 8-7s8 3.134 8 7" stroke="#fff" stroke-opacity="0.85" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M6 17c0-2.761 2.686-5 6-5s6 2.239 6 5" stroke="#2e2a27" stroke-opacity="0.35" stroke-width="1.6" stroke-linecap="round"/>
            <circle cx="12" cy="17" r="2.2" fill="#fff"/>
          </svg>
        </div>
        <div>
          <h1>TrafficAI Analytics Platform</h1>
          <div class="muted">Intelligent Traffic Classification with Machine Learning & Real-time Analytics</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="k-ctrl">k = <input id="k-input" type="number" min="1" max="10" value="3" style="width:48px; border:none; outline:none; text-align:center;"/></div>
        <button id="btn-reset" title="Khôi phục dữ liệu gốc">Reset</button>
        <button id="btn-admin" title="Admin Panel" class="secondary">⚙️</button>
        <button id="btn-chat" title="AI Assistant" class="secondary">🤖</button>
        <button id="btn-theme" title="Chuyển đổi giao diện" class="secondary">🌙</button>
        <button id="btn-login" title="Đăng nhập" class="primary">Login</button>
      </div>
    </header>

    <nav class="main-nav">
      <div class="nav-container">
        <a href="#dashboard" class="nav-item active" data-section="dashboard">
          <span class="nav-icon">📊</span>
          Dashboard
        </a>
        <a href="#analytics" class="nav-item" data-section="analytics">
          <span class="nav-icon">📈</span>
          Analytics
        </a>
        <a href="#models" class="nav-item" data-section="models">
          <span class="nav-icon">🤖</span>
          ML Models
        </a>
        <a href="#reports" class="nav-item" data-section="reports">
          <span class="nav-icon">📋</span>
          Reports
        </a>
        <a href="#settings" class="nav-item" data-section="settings">
          <span class="nav-icon">⚙️</span>
          Settings
        </a>
      </div>
    </nav>

    <section class="hero">
      <div>
        <h3>AI-Powered Traffic Intelligence</h3>
        <p>Advanced machine learning algorithms for real-time traffic pattern analysis and predictive modeling.</p>
        <div class="hero-stats">
          <div class="stat-item">
            <span class="stat-number">99.2%</span>
            <span class="stat-label">Accuracy</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">24/7</span>
            <span class="stat-label">Monitoring</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">5ms</span>
            <span class="stat-label">Response Time</span>
          </div>
        </div>
      </div>
      <div class="hero-art"></div>
    </section>

    <section class="kpi-grid">
      <div class="kpi"><div class="label">Mẫu dữ liệu</div><div class="value" id="kpi-samples">—</div></div>
      <div class="kpi"><div class="label">Xe/phút trung bình</div><div class="value" id="kpi-xe">—</div></div>
      <div class="kpi"><div class="label">Tốc độ TB (km/h)</div><div class="value" id="kpi-speed">—</div></div>
      <div class="kpi"><div class="label">Độ chính xác (LOO)</div><div class="value" id="kpi-acc">—</div></div>
    </section>

          <!-- Dashboard Section -->
      <div id="dashboard-section" class="content-section active">
        <div class="grid">
          <section class="card" id="card-data">
            <div class="card-header"><div class="card-title"><span class="dot"></span><h2>Dữ liệu mẫu</h2></div><div class="chev-btn"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
            <div class="card-body">
              <div style="overflow:auto;">
                <table id="data-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Giờ</th>
                      <th>Xe/phút</th>
                      <th>Thời tiết</th>
                      <th>Tốc độ TB</th>
                      <th>Sự kiện</th>
                      <th>Làn</th>
                      <th>Ngày</th>
                      <th>Nhãn</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="card" id="card-chart">
            <div class="card-header"><div class="card-title"><span class="dot"></span><h2>Phân bố nhãn</h2></div><div class="chev-btn"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
            <div class="card-body">
              <canvas id="chart" width="400" height="200" style="width:100%; height:200px;"></canvas>
            </div>
          </section>

          <section class="card" id="card-predict">
            <div class="card-header"><div class="card-title"><span class="dot"></span><h2>Dự đoán nhanh <span class="k-badge">k-NN (k=<span id="k-val">3</span>)</span></h2></div><div class="chev-btn"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
            <div class="card-body">
              <div class="controls" style="margin-bottom: 12px;">
                <div class="control">
                  <label for="gio">Giờ (0-23)</label>
                  <input type="number" id="gio" min="0" max="23" step="1" value="8">
                </div>
                <div class="control">
                  <label for="xe">Xe/phút (0-50)</label>
                  <input type="number" id="xe" min="0" max="50" step="1" value="12">
                </div>
                <div class="control">
                  <label for="thoi_tiet">Thời tiết</label>
                  <select id="thoi_tiet">
                    <option value="0">Nắng</option>
                    <option value="1">Mưa</option>
                  </select>
                </div>
                <div class="control">
                  <label for="toc_do">Tốc độ TB (km/h)</label>
                  <input type="number" id="toc_do" min="0" max="120" step="1" value="35">
                </div>
              </div>
              <div class="controls" style="margin-bottom: 12px;">
                <div class="control">
                  <label for="su_kien">Sự kiện</label>
                  <select id="su_kien">
                    <option value="0">Không</option>
                    <option value="1">Có</option>
                  </select>
                </div>
                <div class="control">
                  <label for="lan">Làn đường</label>
                  <input type="number" id="lan" min="1" max="6" step="1" value="3">
                </div>
                <div class="control">
                  <label for="ngay">Ngày</label>
                  <select id="ngay">
                    <option value="0">Ngày thường</option>
                    <option value="1">Ngày nghỉ</option>
                  </select>
                </div>
              </div>
              <div class="actions" style="margin-bottom: 8px;">
                <button id="btn-predict">Dự đoán</button>
                <div id="predict-result" class="muted">Kết quả: —</div>
              </div>
              <div class="footer-note">Chuẩn hóa z-score trên tất cả biến để tăng ổn định.</div>
            </div>
          </section>

          <section class="card" id="card-add">
            <div class="card-header"><div class="card-title"><span class="dot"></span><h2>Thêm mẫu & Huấn luyện lại</h2></div><div class="chev-btn"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
            <div class="card-body">
              <div class="controls" style="margin-bottom: 12px;">
                <div class="control"><label for="gio-new">Giờ</label><input type="number" id="gio-new" min="0" max="23" step="1" value="7"></div>
                <div class="control"><label for="xe-new">Xe/phút</label><input type="number" id="xe-new" min="0" max="50" step="1" value="10"></div>
                <div class="control"><label for="tt-new">Thời tiết</label><select id="tt-new"><option value="0">Nắng</option><option value="1">Mưa</option></select></div>
                <div class="control"><label for="td-new">Tốc độ TB</label><input type="number" id="td-new" min="0" max="120" step="1" value="30"></div>
              </div>
              <div class="controls" style="margin-bottom: 12px;">
                <div class="control"><label for="sk-new">Sự kiện</label><select id="sk-new"><option value="0">Không</option><option value="1">Có</option></select></div>
                <div class="control"><label for="lan-new">Làn đường</label><input type="number" id="lan-new" min="1" max="6" step="1" value="3"></div>
                <div class="control"><label for="ngay-new">Ngày</label><select id="ngay-new"><option value="0">Ngày thường</option><option value="1">Ngày nghỉ</option></select></div>
                <div class="control"><label for="y-new">Nhãn đúng</label><select id="y-new"><option value="0">Thông thoáng</option><option value="1">Trung bình</option><option value="2">Kẹt xe</option></select></div>
              </div>
              <div class="actions">
                <button class="secondary" id="btn-add">Thêm mẫu + Huấn luyện lại</button>
                <div class="stat" id="stat-acc">Độ chính xác (training): —</div>
              </div>
            </div>
          </section>

          <section class="card" id="card-notes">
            <div class="card-header"><div class="card-title"><span class="dot"></span><h2>Ghi chú</h2></div><div class="chev-btn"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
            <div class="card-body">
              <div class="muted">
                - Biến sử dụng: giờ, xe/phút, thời tiết, tốc độ TB, sự kiện, làn, ngày.<br>
                - k-NN (k=3), chuẩn hóa z-score mỗi lần cập nhật dữ liệu.
              </div>
            </div>
          </section>


      <!-- Analytics Section -->
      <div id="analytics-section" class="content-section">
        <div class="analytics-header">
          <h2>📈 Advanced Analytics Dashboard</h2>
          <p>Deep insights into traffic patterns and predictive analytics</p>
        </div>
        
        <div class="analytics-grid">
          <div class="analytics-card">
            <h3>Traffic Flow Analysis</h3>
            <div class="chart-container">
              <canvas id="flow-chart" width="400" height="200"></canvas>
            </div>
            <div class="analytics-insights">
              <div class="insight-item">
                <span class="insight-label">Peak Hours:</span>
                <span class="insight-value">7-9 AM, 5-7 PM</span>
              </div>
              <div class="insight-item">
                <span class="insight-label">Congestion Level:</span>
                <span class="insight-value">Medium</span>
              </div>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Weather Impact Analysis</h3>
            <div class="weather-stats">
              <div class="weather-stat">
                <span class="weather-icon">☀️</span>
                <span class="weather-label">Sunny Days</span>
                <span class="weather-value">75%</span>
              </div>
              <div class="weather-stat">
                <span class="weather-icon">🌧️</span>
                <span class="weather-label">Rainy Days</span>
                <span class="weather-value">25%</span>
              </div>
            </div>
            <div class="weather-impact">
              <p>Weather significantly affects traffic flow. Rainy days show 30% higher congestion.</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Predictive Models</h3>
            <div class="model-metrics">
              <div class="metric">
                <span class="metric-name">k-NN Accuracy</span>
                <span class="metric-value">94.2%</span>
              </div>
              <div class="metric">
                <span class="metric-name">Random Forest</span>
                <span class="metric-value">96.8%</span>
              </div>
              <div class="metric">
                <span class="metric-name">Neural Network</span>
                <span class="metric-value">97.1%</span>
              </div>
            </div>
            <button class="train-model-btn">🔄 Retrain Models</button>
          </div>
        </div>
      </div>

      <!-- ML Models Section -->
      <div id="models-section" class="content-section">
        <div class="models-header">
          <h2>🤖 Machine Learning Models</h2>
          <p>Advanced algorithms for traffic classification and prediction</p>
        </div>
        
        <div class="models-grid">
          <div class="model-card">
            <div class="model-header">
              <h3>k-NN Classifier</h3>
              <span class="model-status active">Active</span>
            </div>
            <div class="model-info">
              <p>K-Nearest Neighbors algorithm for real-time classification</p>
              <div class="model-params">
                <span class="param">k = 3</span>
                <span class="param">Distance: Euclidean</span>
                <span class="param">Normalization: Z-score</span>
              </div>
            </div>
            <div class="model-performance">
              <div class="perf-item">
                <span class="perf-label">Accuracy:</span>
                <span class="perf-value">94.2%</span>
              </div>
              <div class="perf-item">
                <span class="perf-label">Training Time:</span>
                <span class="perf-value">0.3s</span>
              </div>
            </div>
            <div class="model-actions">
              <button class="model-btn primary">📊 View Details</button>
              <button class="model-btn secondary">⚙️ Configure</button>
            </div>
          </div>
          
          <div class="model-card">
            <div class="model-header">
              <h3>Random Forest</h3>
              <span class="model-status training">Training</span>
            </div>
            <div class="model-info">
              <p>Ensemble method combining multiple decision trees</p>
              <div class="model-params">
                <span class="param">Trees: 100</span>
                <span class="param">Max Depth: 10</span>
                <span class="param">Features: Auto</span>
              </div>
            </div>
            <div class="model-performance">
              <div class="perf-item">
                <span class="perf-label">Accuracy:</span>
                <span class="perf-value">96.8%</span>
              </div>
              <div class="perf-item">
                <span class="perf-label">Training Time:</span>
                <span class="perf-value">2.1s</span>
              </div>
            </div>
            <div class="model-actions">
              <button class="model-btn primary">📊 View Details</button>
              <button class="model-btn secondary">⚙️ Configure</button>
            </div>
          </div>
          
          <div class="model-card">
            <div class="model-header">
              <h3>Neural Network</h3>
              <span class="model-status inactive">Inactive</span>
            </div>
            <div class="model-info">
              <p>Deep learning model with multiple hidden layers</p>
              <div class="model-params">
                <span class="param">Layers: 3</span>
                <span class="param">Neurons: 64,32,16</span>
                <span class="param">Activation: ReLU</span>
              </div>
            </div>
            <div class="model-performance">
              <div class="perf-item">
                <span class="perf-label">Accuracy:</span>
                <span class="perf-value">97.1%</span>
              </div>
              <div class="perf-item">
                <span class="perf-label">Training Time:</span>
                <span class="perf-value">15.3s</span>
              </div>
            </div>
            <div class="model-actions">
              <button class="model-btn primary">📊 View Details</button>
              <button class="model-btn secondary">⚙️ Configure</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reports-section" class="content-section">
        <div class="reports-header">
          <h2>📋 Reports & Analytics</h2>
          <p>Comprehensive traffic analysis reports and insights</p>
        </div>
        
        <div class="reports-grid">
          <div class="report-card">
            <div class="report-icon">📊</div>
            <h3>Daily Traffic Report</h3>
            <p>Comprehensive analysis of daily traffic patterns and trends</p>
            <div class="report-meta">
              <span class="report-date">Last updated: Today 14:30</span>
              <span class="report-status">Ready</span>
            </div>
            <button class="report-btn">📥 Download PDF</button>
          </div>
          
          <div class="report-card">
            <div class="report-icon">📈</div>
            <h3>Weekly Performance</h3>
            <p>Weekly traffic performance metrics and comparisons</p>
            <div class="report-meta">
              <span class="report-date">Last updated: Yesterday</span>
              <span class="report-status">Ready</span>
            </div>
            <button class="report-btn">📥 Download PDF</button>
          </div>
          
          <div class="report-card">
            <div class="report-icon">🎯</div>
            <h3>Predictive Analysis</h3>
            <p>Future traffic predictions based on historical data</p>
            <div class="report-meta">
              <span class="report-date">Last updated: 2 days ago</span>
              <span class="report-status">Processing</span>
            </div>
            <button class="report-btn" disabled>⏳ Processing...</button>
          </div>
          
          <div class="report-card">
            <div class="report-icon">🚦</div>
            <h3>Traffic Hotspots</h3>
            <p>Identification of high-congestion areas and recommendations</p>
            <div class="report-meta">
              <span class="report-date">Last updated: 1 week ago</span>
              <span class="report-status">Ready</span>
            </div>
            <button class="report-btn">📥 Download PDF</button>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settings-section" class="content-section">
        <div class="settings-header">
          <h2>⚙️ System Settings</h2>
          <p>Configure system parameters and user preferences</p>
        </div>
        
        <div class="settings-grid">
          <div class="settings-card">
            <h3>General Settings</h3>
            <div class="setting-item">
              <label>System Language</label>
              <select class="setting-select">
                <option value="en">English</option>
                <option value="vi">Tiếng Việt</option>
                <option value="zh">中文</option>
              </select>
            </div>
            <div class="setting-item">
              <label>Time Zone</label>
              <select class="setting-select">
                <option value="UTC+7">UTC+7 (Vietnam)</option>
                <option value="UTC+8">UTC+8 (China)</option>
                <option value="UTC+0">UTC+0 (London)</option>
              </select>
            </div>
            <div class="setting-item">
              <label>Notifications</label>
              <div class="toggle-switch">
                <input type="checkbox" id="notifications" checked>
                <label for="notifications"></label>
              </div>
            </div>
          </div>
          
          <div class="settings-card">
            <h3>ML Model Settings</h3>
            <div class="setting-item">
              <label>Default k value</label>
              <input type="number" class="setting-input" value="3" min="1" max="10">
            </div>
            <div class="setting-item">
              <label>Auto-retrain models</label>
              <div class="toggle-switch">
                <input type="checkbox" id="auto-retrain">
                <label for="auto-retrain"></label>
              </div>
            </div>
            <div class="setting-item">
              <label>Model update frequency</label>
              <select class="setting-select">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
          </div>
          
          <div class="settings-card">
            <h3>Data Management</h3>
            <div class="setting-item">
              <label>Data retention period</label>
              <select class="setting-select">
                <option value="30">30 days</option>
                <option value="90">90 days</option>
                <option value="365">1 year</option>
              </select>
            </div>
            <div class="setting-item">
              <label>Auto-backup</label>
              <div class="toggle-switch">
                <input type="checkbox" id="auto-backup" checked>
                <label for="auto-backup"></label>
              </div>
            </div>
            <div class="setting-item">
              <label>Data export format</label>
              <select class="setting-select">
                <option value="csv">CSV</option>
                <option value="json">JSON</option>
                <option value="excel">Excel</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div id="toast" class="toast">Đã lưu</div>

<!-- Chatbot Modal -->
<div id="chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>🤖 AI Assistant</h3>
      <button class="close-btn" id="close-chat">&times;</button>
    </div>
    <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <div class="message bot">
          <div class="message-content">
            Xin chào! Tôi là AI Assistant của TrafficAI. Tôi có thể giúp bạn:
            <ul>
              <li>Giải thích về thuật toán k-NN</li>
              <li>Hướng dẫn sử dụng hệ thống</li>
              <li>Phân tích dữ liệu giao thông</li>
              <li>Đưa ra gợi ý cải thiện</li>
            </ul>
            Bạn cần hỗ trợ gì?
          </div>
        </div>
      </div>
      <div class="chat-input">
        <input type="text" id="chat-input" placeholder="Nhập câu hỏi của bạn...">
        <button id="send-chat">Gửi</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Panel Modal -->
<div id="admin-modal" class="modal">
  <div class="modal-content admin-content">
    <div class="modal-header">
      <h3>⚙️ Admin Panel</h3>
      <button class="close-btn" id="close-admin">&times;</button>
    </div>
    <div class="admin-tabs">
      <button class="tab-btn active" data-tab="users">👥 Users</button>
      <button class="tab-btn" data-tab="system">🔧 System</button>
      <button class="tab-btn" data-tab="logs">📊 Logs</button>
    </div>
    <div class="tab-content">
      <div id="users-tab" class="tab-pane active">
        <h4>User Management</h4>
        <div class="admin-stats">
          <div class="admin-stat">
            <span class="admin-stat-number">1,247</span>
            <span class="admin-stat-label">Total Users</span>
          </div>
          <div class="admin-stat">
            <span class="admin-stat-number">89</span>
            <span class="admin-stat-label">Active Today</span>
          </div>
          <div class="admin-stat">
            <span class="admin-stat-number">12</span>
            <span class="admin-stat-label">New This Week</span>
          </div>
        </div>
      </div>
      <div id="system-tab" class="tab-pane">
        <h4>System Status</h4>
        <div class="status-grid">
          <div class="status-item online">
            <span class="status-dot"></span>
            <span>API Server</span>
          </div>
          <div class="status-item online">
            <span class="status-dot"></span>
            <span>Database</span>
          </div>
          <div class="status-item online">
            <span class="status-dot"></span>
            <span>ML Engine</span>
          </div>
        </div>
      </div>
      <div id="logs-tab" class="tab-pane">
        <h4>Recent Activity</h4>
        <div class="log-list">
          <div class="log-item">
            <span class="log-time">14:32</span>
            <span class="log-action">User login</span>
            <span class="log-user">admin@trafficai.com</span>
          </div>
          <div class="log-item">
            <span class="log-time">14:28</span>
            <span class="log-action">Model training</span>
            <span class="log-user">ML Engine</span>
          </div>
          <div class="log-item">
            <span class="log-time">14:25</span>
            <span class="log-action">Data export</span>
            <span class="log-user">user@example.com</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="login-modal" class="modal">
  <div class="modal-content login-content">
    <div class="modal-header">
      <h3>🔐 Authentication</h3>
      <button class="close-btn" id="close-login">&times;</button>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" data-auth="login">Login</button>
      <button class="auth-tab" data-auth="register">Register</button>
    </div>
    <div class="auth-content">
      <div id="login-form" class="auth-form active">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" placeholder="Enter your password">
        </div>
        <button class="auth-btn" id="btn-login-submit">Sign In</button>
        <div class="auth-links">
          <a href="#" class="forgot-password">Forgot Password?</a>
        </div>
      </div>
      <div id="register-form" class="auth-form">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="register-name" placeholder="Enter your full name">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="register-email" placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="register-password" placeholder="Create a password">
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="register-confirm" placeholder="Confirm your password">
        </div>
        <button class="auth-btn" id="btn-register-submit">Create Account</button>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'traffic_dataset_v2';
  const K_KEY = 'traffic_knn_k';
  const OPEN_KEY = 'traffic_cards_open_v1';
  const THEME_KEY = 'traffic_theme_v1';

  const initialData = [
    { gio: 7,  xe: 20,  thoi_tiet: 0, toc_do: 35, su_kien: 0, lan: 3, ngay: 0, nhan: 2 },
    { gio: 8,  xe: 15,  thoi_tiet: 1, toc_do: 30, su_kien: 1, lan: 3, ngay: 0, nhan: 2 },
    { gio: 12, xe: 5,   thoi_tiet: 0, toc_do: 50, su_kien: 0, lan: 4, ngay: 0, nhan: 0 },
    { gio: 14, xe: 8,   thoi_tiet: 0, toc_do: 48, su_kien: 0, lan: 4, ngay: 0, nhan: 0 },
    { gio: 18, xe: 12,  thoi_tiet: 1, toc_do: 32, su_kien: 0, lan: 3, ngay: 0, nhan: 1 },
    { gio: 19, xe: 14,  thoi_tiet: 0, toc_do: 28, su_kien: 0, lan: 3, ngay: 0, nhan: 2 },
    { gio: 22, xe: 3,   thoi_tiet: 0, toc_do: 55, su_kien: 0, lan: 4, ngay: 0, nhan: 0 },
    { gio: 9,  xe: 10,  thoi_tiet: 1, toc_do: 36, su_kien: 1, lan: 3, ngay: 0, nhan: 1 },
    { gio: 17, xe: 11,  thoi_tiet: 0, toc_do: 38, su_kien: 0, lan: 3, ngay: 0, nhan: 1 },
    { gio: 6,  xe: 7,   thoi_tiet: 0, toc_do: 52, su_kien: 0, lan: 4, ngay: 0, nhan: 0 },
    { gio: 21, xe: 13,  thoi_tiet: 1, toc_do: 30, su_kien: 0, lan: 3, ngay: 0, nhan: 2 },
  ];

  const LABELS = { 0: "Thông thoáng", 1: "Trung bình", 2: "Kẹt xe" };
  const WEATHER = { 0: "Nắng", 1: "Mưa" };
  const EVENT = { 0: "Không", 1: "Có" };
  const DAY = { 0: "Ngày thường", 1: "Ngày nghỉ" };

  let dataset = [...initialData];
  let k = 3;

  function saveLocal(show=true) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(dataset)); if (show) showToast('Đã lưu dữ liệu'); } catch {}
  }
  function loadLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) dataset = JSON.parse(raw);
      const kSaved = localStorage.getItem(K_KEY);
      if (kSaved) k = Math.max(1, Math.min(10, Number(kSaved)));
      
      // Load theme
      const theme = localStorage.getItem(THEME_KEY) || 'light';
      setTheme(theme);

      

    } catch {}
  }
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; 
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }
  
  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    const btn = document.getElementById('btn-theme');
    if (btn) {
      btn.textContent = theme === 'dark' ? '☀️' : '🌙';
    }
    localStorage.setItem(THEME_KEY, theme);
  }
  
  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
  }
  
  function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;
    
    const chatMessages = document.getElementById('chat-messages');
    
    // Add user message
    const userDiv = document.createElement('div');
    userDiv.className = 'message user';
    userDiv.innerHTML = `<div class="message-content">${message}</div>`;
    chatMessages.appendChild(userDiv);
    
    // Clear input
    input.value = '';
    
    // Simulate AI response
    setTimeout(() => {
      const botDiv = document.createElement('div');
      botDiv.className = 'message bot';
      const response = getAIResponse(message);
      botDiv.innerHTML = `<div class="message-content">${response}</div>`;
      chatMessages.appendChild(botDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 1000);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  function getAIResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('k-nn') || lowerMessage.includes('knn')) {
      return 'Thuật toán k-NN (k-Nearest Neighbors) là một phương pháp học máy đơn giản nhưng hiệu quả. Nó phân loại dữ liệu mới dựa trên k điểm dữ liệu gần nhất trong tập huấn luyện. Trong ứng dụng này, chúng ta sử dụng k=3 để phân loại tình trạng giao thông.';
    } else if (lowerMessage.includes('hướng dẫn') || lowerMessage.includes('sử dụng')) {
      return 'Để sử dụng hệ thống: 1) Nhập dữ liệu giao thông vào form, 2) Điều chỉnh tham số k, 3) Nhấn "Dự đoán" để có kết quả, 4) Xem biểu đồ và thống kê trong các tab.';
    } else if (lowerMessage.includes('giao thông') || lowerMessage.includes('traffic')) {
      return 'Hệ thống phân loại tình trạng giao thông thành 3 mức: Thông thoáng (0), Trung bình (1), và Kẹt xe (2). Dựa trên các yếu tố: giờ, số xe/phút, thời tiết, tốc độ trung bình, sự kiện, làn đường, và ngày.';
    } else {
      return 'Cảm ơn câu hỏi của bạn! Tôi có thể giúp bạn hiểu về thuật toán k-NN, hướng dẫn sử dụng hệ thống, hoặc giải thích về dữ liệu giao thông. Bạn có thể hỏi cụ thể hơn không?';
    }
  }
  
  function switchTab(tabName) {
    // Remove active class from all tabs and panes
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding pane
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
  }
  
  function switchAuthTab(authType) {
    // Remove active class from all auth tabs and forms
    document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding form
    document.querySelector(`[data-auth="${authType}"]`).classList.add('active');
    document.getElementById(`${authType}-form`).classList.add('active');
  }
  
  function switchSection(section) {
    // Remove active class from all nav items
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    
    // Add active class to clicked nav item
    document.querySelector(`[data-section="${section}"]`).classList.add('active');
    
    // Hide all content sections
    document.querySelectorAll('.content-section').forEach(content => {
      content.classList.remove('active');
    });
    
    // Show selected content section
    const selectedSection = document.getElementById(`${section}-section`);
    if (selectedSection) {
      selectedSection.classList.add('active');
    }
    
    showToast(`Switched to ${section} section`);
  }
  


  function computeStatsXs(data) {
    const xs = data.map(r => [r.gio, r.xe, r.thoi_tiet, r.toc_do, r.su_kien, r.lan, r.ngay]);
    const p = xs[0]?.length || 0;
    const means = Array(p).fill(0);
    const stds = Array(p).fill(0);
    const n = xs.length;
    for (let j = 0; j < p; j++) {
      let s = 0; for (const row of xs) s += row[j];
      means[j] = s / n;
      let varSum = 0; for (const row of xs) varSum += Math.pow(row[j] - means[j], 2);
      stds[j] = Math.sqrt(varSum / Math.max(1, n - 1)) || 1;
    }
    return { means, stds };
  }
  function zTransform(row, means, stds) { return row.map((v, i) => (v - means[i]) / (stds[i] || 1)); }
  function distance(a, b) { let s = 0; for (let i = 0; i < a.length; i++) s += (a[i] - b[i]) ** 2; return Math.sqrt(s); }

  function predictKNN(input, data, kVal) {
    if (data.length === 0) return 0;
    const { means, stds } = computeStatsXs(data);
    const Xz = data.map(r => zTransform([r.gio, r.xe, r.thoi_tiet, r.toc_do, r.su_kien, r.lan, r.ngay], means, stds));
    const xz = zTransform(input, means, stds);
    const dists = Xz.map((row, idx) => ({ idx, d: distance(xz, row), y: data[idx].nhan }));
    dists.sort((a,b) => a.d - b.d);
    const top = dists.slice(0, Math.max(1, Math.min(kVal, dists.length)));
    const votes = new Map(); for (const t of top) votes.set(t.y, (votes.get(t.y) || 0) + 1);
    let bestY = 0, bestC = -1; for (const [yy, cc] of votes.entries()) { if (cc > bestC) { bestC = cc; bestY = yy; } }
    return bestY;
  }

  function computeTrainingAccuracy(data, kVal) {
    if (data.length === 0) return 0;
    let correct = 0;
    for (let i = 0; i < data.length; i++) {
      const holdout = data[i];
      const rest = data.slice(0, i).concat(data.slice(i + 1));
      const yhat = predictKNN([holdout.gio, holdout.xe, holdout.thoi_tiet, holdout.toc_do, holdout.su_kien, holdout.lan, holdout.ngay], rest.length ? rest : data, kVal);
      if (yhat === holdout.nhan) correct++;
    }
    return correct / data.length;
  }

  function labelClass(y) { if (y === 0) return 'ok'; if (y === 1) return 'warn'; return 'bad'; }

  function renderTable() {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
    dataset.forEach((r, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${r.gio}</td>
        <td>${r.xe}</td>
        <td>${WEATHER[r.thoi_tiet]}</td>
        <td>${r.toc_do}</td>
        <td>${EVENT[r.su_kien]}</td>
        <td>${r.lan}</td>
        <td>${DAY[r.ngay]}</td>
        <td><span class="pill ${labelClass(r.nhan)}">${LABELS[r.nhan]}</span></td>
      `;
      tbody.appendChild(tr);
    });

  }

  function renderAccuracy() {
    const acc = computeTrainingAccuracy(dataset, k);
    document.getElementById('stat-acc').textContent = `Độ chính xác (training): ${(acc * 100).toFixed(0)}%`;
    document.getElementById('kpi-acc').textContent = `${(acc * 100).toFixed(0)}%`;
  }

  function renderKPIs() {
    const n = dataset.length;
    const avgXe = n ? (dataset.reduce((s,d)=>s+d.xe,0)/n) : 0;
    const avgSpeed = n ? (dataset.reduce((s,d)=>s+d.toc_do,0)/n) : 0;
    document.getElementById('kpi-samples').textContent = String(n);
    document.getElementById('kpi-xe').textContent = avgXe.toFixed(1);
    document.getElementById('kpi-speed').textContent = avgSpeed.toFixed(1);
  }

  function renderChart() {
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const counts = [0,0,0];
    dataset.forEach(d => counts[d.nhan]++);
    const labels = ['Thông thoáng','Trung bình','Kẹt xe'];
    const colors = ['#10b981', '#f59e0b', '#ef4444'];
    const gradients = [
      ['#10b981', '#059669'],
      ['#f59e0b', '#d97706'],
      ['#ef4444', '#dc2626']
    ];
    const w = canvas.width, h = canvas.height, pad = 50, bw = (w - pad*2) / counts.length - 40;
    const max = Math.max(1, ...counts);
    
    // Background with subtle pattern
    ctx.fillStyle = 'rgba(102, 126, 234, 0.02)';
    for (let i = 0; i < w; i += 20) {
      for (let j = 0; j < h; j += 20) {
        if ((i + j) % 40 === 0) {
          ctx.fillRect(i, j, 2, 2);
        }
      }
    }
    
    // Background grid
    ctx.strokeStyle = 'rgba(102, 126, 234, 0.1)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 5; i++) {
      const y = pad + (h - pad*2) * i / 5;
      ctx.beginPath();
      ctx.moveTo(pad, y);
      ctx.lineTo(w - pad, y);
      ctx.stroke();
    }
    
    ctx.font = '14px Inter'; 
    ctx.textAlign = 'center';
    
    counts.forEach((c, i) => {
      const x = pad + i*((w-pad*2)/counts.length) + (w-pad*2)/counts.length/2;
      const bh = (h - pad*2) * (c / max);
      const y = h - pad - bh;
      
      // Bar with beautiful gradient
      const gradient = ctx.createLinearGradient(x - bw/2, y, x - bw/2, h - pad);
      gradient.addColorStop(0, gradients[i][0]);
      gradient.addColorStop(1, gradients[i][1]);
      
      // Bar shadow
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(x - bw/2 + 3, y + 3, bw, bh);
      
      // Main bar
      ctx.fillStyle = gradient;
      ctx.fillRect(x - bw/2, y, bw, bh);
      
      // Bar highlight
      const highlightGradient = ctx.createLinearGradient(x - bw/2, y, x - bw/2, y + 20);
      highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
      highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
      ctx.fillStyle = highlightGradient;
      ctx.fillRect(x - bw/2, y, bw, Math.min(20, bh));
      
      // Bar border
      ctx.strokeStyle = gradients[i][1];
      ctx.lineWidth = 2;
      ctx.strokeRect(x - bw/2, y, bw, bh);
      
      // Value text with shadow
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.font = 'bold 18px Inter';
      ctx.fillText(String(c), x + 1, y - 8);
      
      ctx.fillStyle = '#1f2937';
      ctx.fillText(String(c), x, y - 10);
      
      // Label text
      ctx.fillStyle = '#6b7280';
      ctx.font = '13px Inter';
      ctx.fillText(labels[i], x, h - pad + 25);
    });
  }





  function bindCollapsibles() {
    document.querySelectorAll('.card').forEach(card => {
      const header = card.querySelector('.card-header');
      header.addEventListener('click', () => {
        card.classList.toggle('open');
        const states = {};
        document.querySelectorAll('.card').forEach(c => states[c.id] = c.classList.contains('open'));
        try { localStorage.setItem(OPEN_KEY, JSON.stringify(states)); } catch {}
      });
    });
  }

  function restoreOpenStates() {
    try {
      const raw = localStorage.getItem(OPEN_KEY);
      const states = raw ? JSON.parse(raw) : {};
      ['card-data','card-predict','card-add','card-notes','card-chart'].forEach(id => {
        const el = document.getElementById(id);
        if (states[id]) el.classList.add('open'); else el.classList.remove('open');
      });
    } catch {}
  }

  function renderAll() {
    renderTable();
    renderAccuracy();
    renderKPIs();
    renderChart();
  }

  function init() {
    loadLocal();
    restoreOpenStates();
    bindCollapsibles();

    renderAll();

    document.getElementById('k-val').textContent = String(k);
    const kInput = document.getElementById('k-input');
    kInput.value = String(k);
    kInput.addEventListener('change', () => {
      k = Math.max(1, Math.min(10, Number(kInput.value)));
      document.getElementById('k-val').textContent = String(k);
      localStorage.setItem(K_KEY, String(k));
      renderAccuracy();
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
      dataset = [...initialData];
      saveLocal(false);
      showToast('Đã reset dữ liệu');
      renderAll();
    });
    
    // Theme toggle
    document.getElementById('btn-theme').addEventListener('click', toggleTheme);
    
    // Chatbot
    document.getElementById('btn-chat').addEventListener('click', () => {
      document.getElementById('chat-modal').classList.add('show');
    });
    
    document.getElementById('close-chat').addEventListener('click', () => {
      document.getElementById('chat-modal').classList.remove('show');
    });
    
    // Admin Panel
    document.getElementById('btn-admin').addEventListener('click', () => {
      document.getElementById('admin-modal').classList.add('show');
    });
    
    document.getElementById('close-admin').addEventListener('click', () => {
      document.getElementById('admin-modal').classList.remove('show');
    });
    
    // Login Modal
    document.getElementById('btn-login').addEventListener('click', () => {
      document.getElementById('login-modal').classList.add('show');
    });
    
    document.getElementById('close-login').addEventListener('click', () => {
      document.getElementById('login-modal').classList.remove('show');
    });
    
    // Chat functionality
    document.getElementById('send-chat').addEventListener('click', sendMessage);
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // Admin tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;
        switchTab(tabName);
      });
    });
    
    // Auth tabs
    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const authType = tab.dataset.auth;
        switchAuthTab(authType);
      });
    });
    
    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const section = item.dataset.section;
        switchSection(section);
      });
    });

    document.getElementById('btn-predict').addEventListener('click', () => {
      const gio = Number(document.getElementById('gio').value);
      const xe = Number(document.getElementById('xe').value);
      const tt = Number(document.getElementById('thoi_tiet').value);
      const td = Number(document.getElementById('toc_do').value);
      const sk = Number(document.getElementById('su_kien').value);
      const lan = Number(document.getElementById('lan').value);
      const ngay = Number(document.getElementById('ngay').value);
      const yhat = predictKNN([gio, xe, tt, td, sk, lan, ngay], dataset, k);
      const el = document.getElementById('predict-result');
      el.innerHTML = `Kết quả: <span class="pill ${labelClass(yhat)}">${LABELS[yhat]} (${yhat})</span>`;
    });

    document.getElementById('btn-add').addEventListener('click', () => {
      const gio = Number(document.getElementById('gio-new').value);
      const xe = Number(document.getElementById('xe-new').value);
      const tt = Number(document.getElementById('tt-new').value);
      const td = Number(document.getElementById('td-new').value);
      const sk = Number(document.getElementById('sk-new').value);
      const lan = Number(document.getElementById('lan-new').value);
      const ngay = Number(document.getElementById('ngay-new').value);
      const y = Number(document.getElementById('y-new').value);
      dataset.push({ gio, xe, thoi_tiet: tt, toc_do: td, su_kien: sk, lan, ngay, nhan: y });
      saveLocal();
      renderAll();
    });

  } // Close init function

  // Close modals when clicking outside
  window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
      e.target.classList.remove('show');
    }
  });
  
  // Close modals with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal.show').forEach(modal => {
        modal.classList.remove('show');
      });
    }
  });

  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
